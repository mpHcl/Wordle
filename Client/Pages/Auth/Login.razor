@page "/login"
@using Shared.Dtos.Auth
@inject HttpClient Http
@inject ILocalStorageService LocalStorage
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider

<div class="login-container">
    <div class="login-card">
        <h3>Login</h3> 
        <p class="small-text">Sign in to continue to your dashboard</p>

        <input @bind="email" type="email" class="form-control" placeholder="Email address" />
        <input @bind="password" type="password" class="form-control" placeholder="Password" />

        <button class="btn btn-primary" @onclick="LoginUser">Log In</button>

        <p class="small-text mt-3">
            Don’t have an account? <a href="/register">Sign up</a>
        </p>
    </div>
</div>

<style>
    .login-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        background: linear-gradient(135deg, #4f46e5, #3b82f6);
        font-family: 'Segoe UI', sans-serif;
    }

    .login-card {
        background: white;
        padding: 2.5rem;
        border-radius: 1rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        width: 100%;
        max-width: 400px;
        text-align: center;
    }

        .login-card h3 {
            margin-bottom: 1.5rem;
            color: #1e293b;
            font-weight: 600;
        }

    .form-control {
        margin-bottom: 1rem;
        border-radius: 0.5rem;
        padding: 0.75rem 1rem;
        font-size: 1rem;
    }

    .btn-primary {
        width: 100%;
        padding: 0.75rem;
        border-radius: 0.5rem;
        font-size: 1rem;
        background-color: #3b82f6;
        border: none;
        transition: 0.2s ease-in-out;
    }

        .btn-primary:hover {
            background-color: #2563eb;
            transform: translateY(-1px);
        }

    .small-text {
        margin-top: 1rem;
        font-size: 0.9rem;
        color: #6b7280;
    }
</style>

@code {
    private string email;
    private string password;


    private async Task LoginUser() {
        var response = await Http.PostAsJsonAsync("/api/auth/login", new { Email = email, Password = password });
        if (response.IsSuccessStatusCode) {
            var responseDto = await response.Content.ReadFromJsonAsync<LoginResponseDto>() ?? throw new Exception("User not found");

            var token = responseDto.Token;

            await LocalStorage.SetItemAsync("authToken", token);
            await LocalStorage.SetItemAsync("darkMode", responseDto.Settings.DarkMode);
            await LocalStorage.SetItemAsync("hardMode", responseDto.Settings.HardMode);
            await LocalStorage.SetItemAsync("highContrastMode", responseDto.Settings.HighContrastMode);
            await LocalStorage.SetItemAsync("hints", responseDto.Settings.ShowHints);

            ((Client.Auth.JwtAuthenticationStateProvider)AuthStateProvider).NotifyUserAuthentication(token);
            Http.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("bearer", token);

            Navigation.NavigateTo("/", forceLoad: true);
        }
    }
}
