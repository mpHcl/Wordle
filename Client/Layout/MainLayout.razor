@inherits LayoutComponentBase
@inject ILocalStorageService LocalStorage
@inject AuthenticationStateProvider AuthProvider
@inject NavigationManager Navigation

@if (!hideLayout) {
    <div class="page @themeClass">
        <div class="sidebar">
            <NavMenu />
        </div>

        <main>
            <article class="content px-4">
                @Body
            </article>
        </main>
    </div>
}
else {
    @Body
}

@code {
    private AuthenticationState? authState;
    private bool hideLayout;
    private string themeClass = "light-theme";

    protected override async Task OnInitializedAsync() {
        if (!await LocalStorage.ContainKeyAsync("authToken"))
        {
            Navigation.NavigateTo("/login");
        }
        authState = await AuthProvider.GetAuthenticationStateAsync();
        UpdateLayoutVisibility();
        Navigation.LocationChanged += (_, __) => UpdateLayoutVisibility();

        if (await LocalStorage.ContainKeyAsync("darkMode")) {
            if (await LocalStorage.GetItemAsync<bool>("darkMode")) {
                themeClass = "dark-theme";
            }
        }
        else {
            await LocalStorage.SetItemAsync<bool>("darkMode", false);
        }

        if (await LocalStorage.ContainKeyAsync("highContrastMode"))
        {
            if (await LocalStorage.GetItemAsync<bool>("highContrastMode")) {
                themeClass = "high-contrast-theme";
            }
            
        }
        else
        {
            await LocalStorage.SetItemAsync<bool>("highContrastMode", false);
        }
    }

    private void UpdateLayoutVisibility() {
        var currentUri = Navigation.ToBaseRelativePath(Navigation.Uri).ToLower();
        hideLayout = currentUri.StartsWith("login") || currentUri.StartsWith("register");
        InvokeAsync(StateHasChanged);
    }
}