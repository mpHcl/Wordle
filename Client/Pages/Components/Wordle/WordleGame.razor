@using System.Security.Cryptography
@using Client.Pages.Components.Wordle
@using Shared
@using Shared.Dtos

@inject NavigationManager Navigation
@inject HttpClient Http
@inject ILocalStorageService LocalStorage

@if (GameDto == null) {
    <p>Loading game...</p>
    return;
}
else {
    <WordleBoard Cols="5" Rows="6" History=@GameDto?.Attempts />

    <section class="controls">
        <WordleInput @bind-CurrentGuess="Current"
                     HandleKeyDown="@HandleKeyDown"
                     SubmitGuess="@SubmitGuess"
                     Disabled="@(GameDto?.GameStatus != GameStatus.InProgress)" />
        <WordleKeyboard KeyStates="@KeyStates" OnKeyPress="@HandleKeyPress" />
        <WordleStatus Message="@Message" />
        <WordleNewAchievements Achievements=@GameDto?.NewAchievements />
        @if(GameDto?.GameStatus != GameStatus.InProgress)
        {
            <WordleFinished GameDto="@GameDto"/>
        }
    </section>
}


<style>
    .controls {
        margin-top: 1rem;
        text-align: center;
    }
</style>

@code {
    [Parameter] public GameDto? GameDto { get; set; }
    List<CellState[]> Evaluation = new();
    Dictionary<char, CellState> KeyStates = new();
    string Current = "";
    string Message = "";

    protected override void OnParametersSet() {
        if (GameDto is not null) {
            CalculateKeyStates();
        }
    }

    async Task HandleKeyDown(KeyboardEventArgs e) {
        if (e.Key == "Enter") {
            await SubmitGuess();
        }
    }

    async Task HandleKeyPress(string key) {
        if (key == "Enter") {
            await SubmitGuess();
        }
        else if (key == "⌫" && Current.Length > 0) {
            Current = Current[..^1];
        }
        else if (key.Length == 1 && char.IsLetter(key[0]) && Current.Length < 5) {
            Current += key.ToLower();
        }
    }

    async Task SubmitGuess() {
        if (Current.Length < 5) return;

        try {
            var token = await LocalStorage.GetItemAsync<string>("authToken");
            Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);

            var response = await Http.PostAsJsonAsync($"/api/games/{GameDto?.Id}/attempt", Current);
            if (response.IsSuccessStatusCode) {
                GameDto = await response.Content.ReadFromJsonAsync<GameDto>();
                Current = "";
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.BadRequest)
            {
                var dict = await response.Content.ReadFromJsonAsync<Dictionary<string, string>>();

                if (dict != null && dict.TryGetValue("message", out var message)) {
                    Console.WriteLine("Message: " + message);
                }
            }
        }
        catch (Exception ex) {
            Console.WriteLine(ex.Message);
        }
        finally {
            CalculateKeyStates();
        }
    }

    private void CalculateKeyStates() {
        KeyStates.Clear();

        foreach (var attempt in GameDto!.Attempts) {
            if (string.IsNullOrEmpty(attempt.Attempt))
                continue;

            for (int i = 0; i < attempt.Attempt.Length && i < attempt.LettersState.Count(); i++) {
                char letter = char.ToLower(attempt.Attempt[i]);
                var newState = attempt.LettersState.ElementAt(i) switch {
                    State.LetterGuessedCorrectPlace => CellState.Correct,
                    State.LetterGuessedIncorrectPlace => CellState.Present,
                    _ => CellState.Absent
                };

                if (KeyStates.TryGetValue(letter, out var currentState)) {
                    if (IsStrongerState(newState, currentState))
                        KeyStates[letter] = newState;
                }
                else {
                    KeyStates[letter] = newState;
                }
            }
        }
    }

    private bool IsStrongerState(CellState newState, CellState currentState) {
        // Correct > Present > Absent
        int Priority(CellState s) => s switch {
            CellState.Correct => 3,
            CellState.Present => 2,
            _ => 1
        };

        return Priority(newState) > Priority(currentState);
    }
}