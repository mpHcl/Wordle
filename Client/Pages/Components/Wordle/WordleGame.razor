@using System.Security.Cryptography
@using Client.Pages.Components.Wordle
@using Shared

@inject HttpClient Http
@inject ILocalStorageService LocalStorage

@if (GameDto == null)
{
    <p>Loading game...</p>
    return;
}
else {
<WordleBoard Cols="5" Rows="6" History=@GameDto?.Attempts />

<section class="controls">
    <WordleInput @bind-CurrentGuess="Current" HandleKeyDown=@HandleKeyDown SubmitGuess=@SubmitGuess />
    <WordleKeyboard KeyStates="@KeyStates" OnKeyPress="@HandleKeyPress" />
    <WordleStatus Message="@Message" />
</section>
}


<style>
    .controls {
        margin-top: 1rem;
        text-align: center;
    }
</style>

@code {
    [Parameter] public GameDto? GameDto { get; set; }
    List<CellState[]> Evaluation = new();
    Dictionary<char, CellState> KeyStates = new();
    string Solution = "apple";
    string Current = "";
    string Message = "";

    async Task HandleKeyDown(KeyboardEventArgs e) {
        if (e.Key == "Enter") await SubmitGuess();
        else if (e.Key == "Backspace" && Current.Length > 0)
            Current = Current[..^1];
    }

    async Task HandleKeyPress(string key)
    {
        if (key == "Enter") await SubmitGuess();
        else if (key == "⌫" && Current.Length > 0) Current = Current[..^1];
        else if (key.Length == 1 && char.IsLetter(key[0]) && Current.Length < 5)
            Current += key.ToLower();
    }

    async Task SubmitGuess()
    {
        if (Current.Length < 5) return;

        try
        {
            var token = await LocalStorage.GetItemAsync<string>("authToken");
            Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);

            var response = await Http.PostAsJsonAsync($"/api/game/{GameDto?.Id}/attempt", Current);
            if (response.IsSuccessStatusCode)
            {
                GameDto = await response.Content.ReadFromJsonAsync<GameDto>();
            }
        } catch (Exception ex)
        {

        }
        Current = "";
    }

    CellState[] Evaluate(string guess, string solution)
    {
        var result = new CellState[5];
        for (int i = 0; i < 5; i++)
            result[i] = guess[i] == solution[i] ? CellState.Correct :
                        solution.Contains(guess[i]) ? CellState.Present :
                        CellState.Absent;
        return result;
    }
}